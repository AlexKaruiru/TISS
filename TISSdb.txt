TISS INTEGRATION DATABASE OBJECTS
=================================

TABLES:
1. TISS_ApiRequests

	 - Stores details of every API request made to TISS.

 	- Columns: RequestID, MessageID, Endpoint, Method, Headers, RequestBody, RequestTime, ParticipantID

2. TISS_ApiResponses

 - Stores details of the responses received from TISS for each request.

 - Columns: ResponseID, RequestID, StatusCode, ResponseBody, ResponseTime, ErrorDetails


STORED PROCEDURES:


1. sp_TISS_LogApiRequest

	- Logs an API request before it is sent to TISS.

	- Parameters: @MessageID, @Endpoint, @Method, @Headers, @RequestBody, @ParticipantID, @RequestID (OUTPUT)

2. sp_TISS_LogApiResponse

	- Logs the response received from TISS for a given request.

	- Parameters: @RequestID, @StatusCode, @ResponseBody, @ErrorDetails

TABLE QUERIES:

CREATE TABLE TISS_ApiRequests (
    RequestID BIGINT PRIMARY KEY IDENTITY(1,1),
    MessageID NVARCHAR(50) NOT NULL,
    Endpoint NVARCHAR(100) NOT NULL,
    Method NVARCHAR(10) NOT NULL,
    Headers NVARCHAR(MAX) NOT NULL, -- JSON serialized headers
    RequestBody NVARCHAR(MAX) NULL,
    RequestTime DATETIME NOT NULL DEFAULT GETDATE(),
    ParticipantID NVARCHAR(20) NOT NULL
);

CREATE TABLE TISS_ApiResponses (
    ResponseID BIGINT PRIMARY KEY IDENTITY(1,1),
    RequestID BIGINT NOT NULL,
    StatusCode INT NOT NULL,
    ResponseBody NVARCHAR(MAX) NULL,
    ResponseTime DATETIME NOT NULL DEFAULT GETDATE(),
    ErrorDetails NVARCHAR(MAX) NULL,
    FOREIGN KEY (RequestID) REFERENCES TISS_ApiRequests(RequestID)
);

CREATE TABLE TISS_ClientConfigurations (
    ClientId VARCHAR(50) PRIMARY KEY,
    ClientSecret VARCHAR(100) NOT NULL,
    TissSenderBic VARCHAR(11) NOT NULL,
    TissAuthToken VARCHAR(100) NOT NULL,
    IsActive BIT DEFAULT 1,
    CreatedDate DATETIME DEFAULT GETDATE(),
    ModifiedDate DATETIME NULL
);

STORED PROCEDURES:

-- For logging requests
CREATE PROCEDURE sp_TISS_LogApiRequest
    @MessageID NVARCHAR(50),
    @Endpoint NVARCHAR(100),
    @Method NVARCHAR(10),
    @Headers NVARCHAR(MAX),
    @RequestBody NVARCHAR(MAX) = NULL,
    @ParticipantID NVARCHAR(20),
    @RequestID BIGINT OUTPUT
AS
BEGIN
    INSERT INTO TISS_ApiRequests (
        MessageID, Endpoint, Method, Headers, 
        RequestBody, ParticipantID, RequestTime
    )
    VALUES (
        @MessageID, @Endpoint, @Method, @Headers,
        @RequestBody, @ParticipantID, GETDATE()
    );
    
    SET @RequestID = SCOPE_IDENTITY();
END

-- For logging responses
CREATE PROCEDURE sp_TISS_LogApiResponse
    @RequestID BIGINT,
    @StatusCode INT,
    @ResponseBody NVARCHAR(MAX) = NULL,
    @ErrorDetails NVARCHAR(MAX) = NULL
AS
BEGIN
    INSERT INTO TISS_ApiResponses (
        RequestID, StatusCode, ResponseBody, 
        ResponseTime, ErrorDetails
    )
    VALUES (
        @RequestID, @StatusCode, @ResponseBody,
        GETDATE(), @ErrorDetails
    );
END






CREATE PROCEDURE sp_GetTissHeadersByToken
    @Token NVARCHAR(255)
AS
BEGIN
    SELECT 
        TissSenderBic,
        TissAuthorization
    FROM InternalTokenMappings
    WHERE Token = @Token 
      AND IsActive = 1
      AND (ExpiryDate IS NULL OR ExpiryDate > GETDATE())
END