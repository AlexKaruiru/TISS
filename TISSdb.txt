TISS INTEGRATION DATABASE OBJECTS
=================================

This document captures the database schema and stored procedures used for
integrating with the TISS system. It is structured in the following order:

1. Tables
2. Create Table Queries
3. Stored Procedures


------------------------------------------------
1. TABLES
------------------------------------------------

1.1 t_MXApiRequests
    - Stores details of every API request made to TISS.
    - Columns:
        RequestID, MessageID, Endpoint, Method, Headers, 
        RequestBody, RequestTime, ParticipantID

1.2 t_MXApiResponses
    - Stores details of the responses received from TISS for each request.
    - Columns:
        ResponseID, RequestID, StatusCode, ResponseBody,
        ResponseTime, ErrorDetails

1.3 t_MXApiHeadersConfig
    - Stores reusable header configurations for TISS API calls.
    - Columns:
        Id, ConfigName, Authorization, Sender, Consumer,
        DefaultContentType, DefaultPayloadType, IsActive,
        CreatedDate, ModifiedDate


------------------------------------------------
2. CREATE TABLE QUERIES
------------------------------------------------

CREATE TABLE t_MXApiRequests (
    RequestID BIGINT PRIMARY KEY IDENTITY(1,1),
    MessageID NVARCHAR(50) NOT NULL,
    Endpoint NVARCHAR(100) NOT NULL,
    Method NVARCHAR(10) NOT NULL,
    Headers NVARCHAR(MAX) NOT NULL, 
    RequestBody XML,
    RequestTime DATETIME NOT NULL DEFAULT GETDATE(),
    ParticipantID NVARCHAR(20) NOT NULL
);

CREATE TABLE t_MXApiResponses (
    ResponseID BIGINT PRIMARY KEY IDENTITY(1,1),
    RequestID BIGINT NOT NULL,
    StatusCode INT NOT NULL,
    ResponseBody NVARCHAR(MAX) NULL,
    ResponseTime DATETIME NOT NULL DEFAULT GETDATE(),
    ErrorDetails NVARCHAR(MAX) NULL,
    FOREIGN KEY (RequestID) REFERENCES t_MXApiRequests(RequestID)
);

CREATE TABLE t_MXApiHeadersConfig (
    Id INT PRIMARY KEY IDENTITY(1,1),
    ConfigName NVARCHAR(100) NOT NULL,
    [Authorization] NVARCHAR(MAX) NOT NULL,
    Sender NVARCHAR(20) NOT NULL,
    Consumer NVARCHAR(20) NOT NULL,
    DefaultContentType NVARCHAR(100) NOT NULL DEFAULT 'application/xml',
    DefaultPayloadType NVARCHAR(50) NOT NULL DEFAULT 'XML',
    DefaultCurrency VARCHAR(3) NOT NULL DEFAULT 'TZS',
    IsActive BIT NOT NULL DEFAULT 1,
    CreatedDate DATETIME NOT NULL DEFAULT GETDATE(),
    ModifiedDate DATETIME NULL
);


------------------------------------------------
3. STORED PROCEDURES
------------------------------------------------

3.1 p_MXLogApiRequest
    - Logs an API request before it is sent to TISS.
    - Parameters:
        @MessageID, @Endpoint, @Method, @Headers, 
        @RequestBody, @ParticipantID, @RequestID (OUTPUT)

CREATE PROCEDURE p_MXLogApiRequest
    @MessageID NVARCHAR(50),
    @Endpoint NVARCHAR(100),
    @Method NVARCHAR(10),
    @Headers NVARCHAR(MAX),
    @RequestBody XML,
    @ParticipantID NVARCHAR(20),
    @RequestID BIGINT OUTPUT
AS
BEGIN
    INSERT INTO t_MXApiRequests (
        MessageID, Endpoint, Method, Headers, 
        RequestBody, ParticipantID, RequestTime
    )
    VALUES (
        @MessageID, @Endpoint, @Method, @Headers,
        @RequestBody, @ParticipantID, GETDATE()
    );
    
    SET @RequestID = SCOPE_IDENTITY();
END;


3.2 p_MXLogApiResponse
    - Logs the response received from TISS for a given request.
    - Parameters:
        @RequestID, @StatusCode, @ResponseBody, @ErrorDetails

CREATE PROCEDURE p_MXLogApiResponse
    @RequestID BIGINT,
    @StatusCode INT,
    @ResponseBody NVARCHAR(MAX) = NULL,
    @ErrorDetails NVARCHAR(MAX) = NULL
AS
BEGIN
    INSERT INTO t_MXApiResponses (
        RequestID, StatusCode, ResponseBody, 
        ResponseTime, ErrorDetails
    )
    VALUES (
        @RequestID, @StatusCode, @ResponseBody,
        GETDATE(), @ErrorDetails
    );
END;



3.3 p_GetMXApiHeaders
    - Retrieves default API header configurations for TISS.
    - Parameters:
        @ConfigName (defaults to 'Default')

CREATE PROCEDURE p_GetMXApiHeaders
    @ConfigName VARCHAR(100) = 'Default'
AS
BEGIN
    SELECT 
        [Authorization],
        Sender,
        Consumer,
        DefaultContentType AS ContentType,
        DefaultPayloadType AS PayloadType
    FROM t_MXApiHeadersConfig
    WHERE ConfigName = @ConfigName
      AND IsActive = 1;
END;

------------------------------------------------
END OF DOCUMENT
------------------------------------------------
